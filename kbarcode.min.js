self.addEventListener("message",function(i){function t(i,t){for(var e=0,s=i;t>s;++s)e+=this_pixels[s];this_avgGray=e/(t-i)}function e(i,e,s){i=Math.floor(i),e=Math.ceil(e);var r=e-i+1,a=r/6,h=r/42;t(i,e);for(var B=[],_=0;6>_;++_){for(var l="",o=0;7>o;++o)l+=this_getBit(Math.floor(i+a*_+h*o),h,s);B.push(l)}return B}if(i.data.cmd&&"decode"==i.data.cmd){var s,r,a;this_quietSize=6,this_height=1,this_avgGray=0,this_pixels=i.data.msg,this_width=this_pixels.length,this_center=parseInt(this_width/2),this_getBit=function(i,t,e){var s,r=0,a=parseInt(i),h=parseInt(t)||1,B=[],_=this_pixels.length;if(1==h)s=this_pixels[a],B=s;else{r=(this_pixels[a]+this_pixels[a+h-1])/2,B.push([this_pixels[a],_>a+h?this_pixels[a+h-1]:0]);for(var l=a+1;h+a-1>l;++l)r+=_>l?this_pixels[l]:0,B.push(_>l?this_pixels[l]:0);var s=r/(h-1)}var o=s<this_avgGray?1:0;return e&&(console.log("checking bit at point "+a,"bitsize "+h,"gray is "+this_avgGray,"sum is "+r,"avg is "+s,"bit is "+o),console.log(a,B)),o};var h={success:0};t(0,this_width);var B=Math.ceil(this_width/109);h.pixels=this_pixels;for(var _=1;B>_;++_){h.bitsize=_,h.quietSize=this_quietSize;for(var l=this_center;l>=0;--l){t(l,l+95);var o=1;for(r=l;r<this_quietSize*_+l;++r)if(this_pixels[r]<this_avgGray+20){o=0;break}if(o){h.left=l,h.level=1;var f=l+_*(95+this_quietSize),n=l+(_+1)*(95+this_quietSize);for(n+this_quietSize*_>this_pixels.length&&(n=this_pixels.length-this_quietSize*_);this_pixels[r]>this_avgGray&&r<this_center;)r++;var v=r;h.bcStart=v;for(var g=f;n>g;++g){t(l,l+95);var u=g-v,p=u/95;for(o=1,r=g;r<this_quietSize*p+g;++r)if(this_pixels[r]<this_avgGray){o=0;break}if(o){if(h.right=g,h.level=2,h.gray=this_avgGray,h.bcWidth=u,h.bitsize=p,t(v,g),!this_getBit(v,p)||this_getBit(v+p,p)||!this_getBit(v+2*p,p))break;h.leftMarker=[v,v+p,v+2*p],h.level=3;var A=parseInt(g-3*p);if(!this_getBit(A,p)||this_getBit(A+p,p)||!this_getBit(A+2*p,p))break;h.rightMarker=[A,A+p,A+2*p],h.level=4;var d=parseInt(v+u/2-2.5*p);if(this_getBit(d,p)||!this_getBit(d+p,p)||this_getBit(d+2*p,p)||!this_getBit(d+3*p,p)||this_getBit(d+4*p,p))break;for(h.middleMarker=[d,d+p,d+2*p,d+3*p,d+4*p],h.level=5;this_pixels[A-1]<this_avgGray;)A--;for(h.lBytesLBound=parseInt(v+3*p);this_pixels[h.lBytesLBound]<this_avgGray;)h.lBytesLBound++;for(h.lBytesRBound=d-1,h.rBytesLBound=d+5*p;this_pixels[h.rBytesLBound-1]<this_avgGray;)h.rBytesLBound--;for(h.rBytesRBound=A-1;this_pixels[h.rBytesRBound]<this_avgGray;)h.rBytesRBound--;var y=e(h.lBytesLBound,h.lBytesRBound),c=e(h.rBytesLBound,h.rBytesRBound);h.level=6,h.lbytes=y,h.rbytes=c;var x=[["0001101","0100111","1110010"],["0011001","0110011","1100110"],["0010011","0011011","1101100"],["0111101","0100001","1000010"],["0100011","0011101","1011100"],["0110001","0111001","1001110"],["0101111","0000101","1010000"],["0111011","0010001","1000100"],["0110111","0001001","1001000"],["0001011","0010111","1110100"]],b={AAAAAA:0,AABABB:1,AABBAB:2,AABBBA:3,ABAABB:4,ABBAAB:5,ABBBAA:6,ABABAB:7,ABABBA:8,ABBABA:9},k=[],z=1,G="";for(r=0;6>r;++r){for(s=0;10>s;++s){if(x[s][0]==y[r]){k[r]=s,G+="A";break}if(x[s][1]==y[r]){k[r]=s,G+="B";break}}10==s&&(z=0)}var S=b[G];if(void 0!==S){for(r=0;6>r;++r){for(s=0;10>s;++s)if(x[s][2]==c[r]){k[r+6]=s;break}10==s&&(z=0)}if(!z)break;k.unshift(S);var q=0,L=0;for(r=12;r;r-=2)q+=k[r];for(r=11;r>0;r-=2)L+=k[r];if(a=q+3*L,a=10-a%10,k[0]!=a)break;return h.digits=k,h.success=1,h.value=h.digits.join(""),self.postMessage(h)}}}}}}self.postMessage(h)}});
